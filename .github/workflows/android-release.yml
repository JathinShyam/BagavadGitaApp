name: Build & Release APK on Tag or PR

on:
  pull_request:
    branches:
      - main
      - master
      - dev
  push:
    tags:
      - '*'  # Triggers build on all tags like v1.0.0, v1.1.0, etc.

jobs:
  build-release-apk:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Set up Java (required by EAS and Gradle)
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      # Step 3: Set up Node.js
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Step 4: Install NPM dependencies
      - name: Install dependencies
        run: npm install

      # Step 5: Install Expo & EAS CLI globally
      - name: Install Expo and EAS CLI
        run: |
          npm install -g expo-cli
          npm install -g eas-cli

      # Step 6: Validate PNG image files (sanity check)
      - name: Validate PNG image files
        run: |
          echo "üîç Checking all PNG files for integrity..."
          find ./assets -iname '*.png' -exec file {} \; | grep -v "PNG image data" && exit 1 || echo "‚úÖ All PNGs valid!"

      # Step 7: Build the APK using EAS
      - name: Build APK with EAS
        run: eas build --platform android --profile production --non-interactive
        env:
          EAS_ACCESS_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}
          EXPO_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}

      # Step 8: Download the latest build artifact (APK)
      - name: Download APK from EAS
        run: eas build:inspect --latest --platform android --output=./apk
        env:
          EAS_ACCESS_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}
          EXPO_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}

      # Step 9: Release APK to GitHub
      - name: Release APK on GitHub
        uses: kyze8439690/action-release-releaseapk@master
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}  # Use a Personal Access Token with repo scope
          APP_FOLDER: apk
