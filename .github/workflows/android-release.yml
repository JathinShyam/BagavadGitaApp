name: ‚ú® Build & Release APK with Validation

on:
  pull_request:
    branches: [main, master, dev]
  push:
    tags:
      - "*"

jobs:
  validate-and-build-release-apk:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout repository
        uses: actions/checkout@v2

      - name: ‚òï Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: üåê Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: üìÅ Install project dependencies
        run: npm install

      - name: ‚ú® Install Expo & EAS CLI
        run: |
          npm install -g expo-cli
          npm install -g eas-cli@latest

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: üñºÔ∏è Validate Image Files
        run: |
          echo "‚ú® Validating image types in ./assets/images"
          for file in ./assets/images/*; do
            if file "$file" | grep -q "JPEG"; then
              echo "‚ùå $file is not a PNG file. Found JPEG."
              exit 1
            fi
          done
          echo "‚úÖ All image files are valid PNGs."

      - name: üíª EAS Build - Android APK
        run: |
          echo "‚öô Starting EAS build for Android"
          eas build --platform android --profile production --non-interactive
        env:
          EAS_ACCESS_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}
          EXPO_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}

      - name: ‚ùì Get latest successful Android build ID
        id: get-build-id
        run: |
          echo "üîç Fetching latest Android build ID..."

          # Always use --non-interactive when using --json
          RAW_OUTPUT=$(eas build:list --platform android --status finished --limit 1 --json --non-interactive 2>/dev/null || echo "[]")

          echo "Raw output: $RAW_OUTPUT"

          # Attempt to parse the build ID
          BUILD_ID=$(echo "$RAW_OUTPUT" | jq -r '.[0].id' 2>/dev/null)

          # Validate build ID
          if [[ -z "$BUILD_ID" || "$BUILD_ID" == "null" ]]; then
            echo "‚ùå No finished build found or invalid JSON output."
            exit 1
          fi

          echo "‚úÖ Found Build ID: $BUILD_ID"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
        env:
          EAS_ACCESS_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}
          EXPO_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}

      - name: üìÅ Download APK
        run: |
          echo "üîç Downloading APK from build ID..."
          BUILD_ID=${{ steps.get-build-id.outputs.BUILD_ID }}
          if [ -z "$BUILD_ID" ]; then
            echo "‚ùå Build ID is empty"
            exit 1
          fi

          # Create output directory
          mkdir -p ./apk

          # Get build details and download URL
          echo "üì• Fetching build details..."
          BUILD_INFO=$(eas build:view "$BUILD_ID" --json)
          if [ $? -ne 0 ]; then
            echo "‚ùå Failed to get build info"
            exit 1
          fi

          # Extract download URL
          DOWNLOAD_URL=$(echo "$BUILD_INFO" | jq -r '.artifacts.url')
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            echo "‚ùå No download URL found in build info"
            echo "Build info: $BUILD_INFO"
            exit 1
          fi

          echo "üì• Downloading APK from: $DOWNLOAD_URL"
          curl -L "$DOWNLOAD_URL" -o "./apk/app.apk"
          if [ $? -ne 0 ]; then
            echo "‚ùå Failed to download APK"
            exit 1
          fi

          echo "‚úÖ APK downloaded successfully"
        env:
          EAS_ACCESS_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}

      - name: üìÉ Release APK on GitHub
        uses: kyze8439690/action-release-releaseapk@master
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
          APP_FOLDER: apk
